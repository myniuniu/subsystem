import React, { useState, useEffect } from 'react';
import {
  Modal,
  Layout,
  Input,
  Button,
  List,
  Card,
  Typography,
  Space,
  Tag,
  Select,
  Divider,
  Avatar,
  Tooltip,
  message,
  Form,
  Row,
  Col
} from 'antd';
import {
  SearchOutlined,
  PlusOutlined,
  EditOutlined,
  DeleteOutlined,
  StarOutlined,
  StarFilled,
  ClockCircleOutlined,
  FolderOpenOutlined,
  TagOutlined,
  SaveOutlined,
  CloseOutlined,
  BoldOutlined,
  ItalicOutlined,
  UnderlineOutlined,
  OrderedListOutlined,
  UnorderedListOutlined,
  LinkOutlined,
  PictureOutlined
} from '@ant-design/icons';
import ReactQuill from 'react-quill';
import 'react-quill/dist/quill.snow.css';
import './NoteCreateModal.css';

const { Sider, Content } = Layout;
const { Title, Text, Paragraph } = Typography;
const { Search } = Input;
const { Option } = Select;

const NoteCreateModal = ({ visible, onCancel, onSave, notes = [], categories = [], tags = [] }) => {
  const [form] = Form.useForm();
  const [selectedNote, setSelectedNote] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedCategory, setSelectedCategory] = useState('all');
  const [filteredNotes, setFilteredNotes] = useState([]);
  const [editorContent, setEditorContent] = useState('');
  const [noteTitle, setNoteTitle] = useState('');
  const [selectedTags, setSelectedTags] = useState([]);
  const [isEditing, setIsEditing] = useState(false);
  const [loading, setLoading] = useState(false);

  // ÈªòËÆ§ÂàÜÁ±ª
  const defaultCategories = [
    { value: 'all', label: 'ÂÖ®ÈÉ®Á¨îËÆ∞', icon: 'üìù' },
    { value: 'work', label: 'Â∑•‰ΩúÁ¨îËÆ∞', icon: 'üíº' },
    { value: 'study', label: 'Â≠¶‰π†Á¨îËÆ∞', icon: 'üìö' },
    { value: 'research', label: 'Á†îÁ©∂Á¨îËÆ∞', icon: 'üî¨' },
    { value: 'personal', label: '‰∏™‰∫∫Á¨îËÆ∞', icon: 'üë§' },
    { value: 'ideas', label: 'ÊÉ≥Ê≥ïÁÅµÊÑü', icon: 'üí°' },
    { value: 'meeting', label: '‰ºöËÆÆËÆ∞ÂΩï', icon: 'ü§ù' }
  ];

  // ÂØåÊñáÊú¨ÁºñËæëÂô®ÈÖçÁΩÆ
  const quillModules = {
    toolbar: [
      [{ 'header': [1, 2, 3, false] }],
      ['bold', 'italic', 'underline', 'strike'],
      [{ 'list': 'ordered'}, { 'list': 'bullet' }],
      [{ 'color': [] }, { 'background': [] }],
      ['link', 'image'],
      ['clean']
    ]
  };

  const quillFormats = [
    'header', 'bold', 'italic', 'underline', 'strike',
    'list', 'bullet', 'color', 'background', 'link', 'image'
  ];

  // ÂàùÂßãÂåñÂíåÈáçÁΩÆ
  useEffect(() => {
    if (visible) {
      setFilteredNotes(notes);
      setSelectedNote(null);
      setEditorContent('');
      setNoteTitle('');
      setSelectedTags([]);
      setIsEditing(false);
      setSearchTerm('');
      setSelectedCategory('all');
    }
  }, [visible, notes]);

  // ÊêúÁ¥¢ÂíåËøáÊª§
  useEffect(() => {
    let filtered = notes;
    
    if (searchTerm) {
      filtered = filtered.filter(note => 
        note.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
        note.content.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }
    
    if (selectedCategory !== 'all') {
      filtered = filtered.filter(note => note.category === selectedCategory);
    }
    
    setFilteredNotes(filtered);
  }, [notes, searchTerm, selectedCategory]);

  // ÈÄâÊã©Á¨îËÆ∞
  const handleSelectNote = (note) => {
    setSelectedNote(note);
    setNoteTitle(note.title);
    setEditorContent(note.content);
    setSelectedTags(note.tags || []);
    setIsEditing(false);
  };

  // Êñ∞Âª∫Á¨îËÆ∞
  const handleCreateNew = () => {
    setSelectedNote(null);
    setNoteTitle('');
    setEditorContent('');
    setSelectedTags([]);
    setIsEditing(true);
  };

  // ÁºñËæëÁ¨îËÆ∞
  const handleEditNote = () => {
    setIsEditing(true);
  };

  // ‰øùÂ≠òÁ¨îËÆ∞
  const handleSaveNote = async () => {
    if (!noteTitle.trim()) {
      message.error('ËØ∑ËæìÂÖ•Á¨îËÆ∞Ê†áÈ¢ò');
      return;
    }

    try {
      setLoading(true);
      const noteData = {
        title: noteTitle,
        content: editorContent,
        category: selectedCategory === 'all' ? 'personal' : selectedCategory,
        tags: selectedTags,
        createdAt: selectedNote ? selectedNote.createdAt : new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      if (selectedNote) {
        noteData.id = selectedNote.id;
      }

      await onSave(noteData);
      setIsEditing(false);
      message.success(selectedNote ? 'Á¨îËÆ∞Êõ¥Êñ∞ÊàêÂäü' : 'Á¨îËÆ∞ÂàõÂª∫ÊàêÂäü');
    } catch (error) {
      console.error('‰øùÂ≠òÂ§±Ë¥•:', error);
      message.error('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
    } finally {
      setLoading(false);
    }
  };

  // ÂèñÊ∂àÁºñËæë
  const handleCancelEdit = () => {
    if (selectedNote) {
      setNoteTitle(selectedNote.title);
      setEditorContent(selectedNote.content);
      setSelectedTags(selectedNote.tags || []);
      setIsEditing(false);
    } else {
      setNoteTitle('');
      setEditorContent('');
      setSelectedTags([]);
      setIsEditing(false);
    }
  };

  // Ëé∑ÂèñÂàÜÁ±ª‰ø°ÊÅØ
  const getCategoryInfo = (categoryValue) => {
    return defaultCategories.find(cat => cat.value === categoryValue) || defaultCategories[0];
  };

  // Ê†ºÂºèÂåñÊó∂Èó¥
  const formatTime = (timeString) => {
    const date = new Date(timeString);
    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (days === 0) {
      return '‰ªäÂ§©';
    } else if (days === 1) {
      return 'Êò®Â§©';
    } else if (days < 7) {
      return `${days}Â§©Ââç`;
    } else {
      return date.toLocaleDateString();
    }
  };

  return (
    <Modal
      title="Êô∫ËÉΩÁ¨îËÆ∞ÁºñËæëÂô®"
      open={visible}
      onCancel={onCancel}
      width={1200}
      height={800}
      footer={null}
      className="note-create-modal"
      destroyOnHidden
    >
      <Layout className="modal-layout">
        {/* Â∑¶‰æßÁ¨îËÆ∞ÂàóË°® */}
        <Sider width={350} className="notes-sidebar">
          <div className="sidebar-header">
            <Button 
              type="primary" 
              icon={<PlusOutlined />}
              onClick={handleCreateNew}
              block
            >
              Êñ∞Âª∫Á¨îËÆ∞
            </Button>
          </div>

          <div className="sidebar-content">
            {/* ÊêúÁ¥¢Ê°Ü */}
            <Search
              placeholder="ÊêúÁ¥¢Á¨îËÆ∞..."
              allowClear
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="search-input"
            />

            {/* ÂàÜÁ±ªÁ≠õÈÄâ */}
            <Select
              value={selectedCategory}
              onChange={setSelectedCategory}
              className="category-select"
              style={{ width: '100%', marginTop: 8 }}
            >
              {defaultCategories.map(category => (
                <Option key={category.value} value={category.value}>
                  <Space>
                    <span>{category.icon}</span>
                    <span>{category.label}</span>
                  </Space>
                </Option>
              ))}
            </Select>

            <Divider style={{ margin: '12px 0' }} />

            {/* Á¨îËÆ∞ÂàóË°® */}
            <div className="notes-list">
              {filteredNotes.length === 0 ? (
                <div className="empty-notes">
                  <Text type="secondary">ÊöÇÊó†Á¨îËÆ∞</Text>
                </div>
              ) : (
                <List
                  dataSource={filteredNotes}
                  renderItem={(note) => {
                    const categoryInfo = getCategoryInfo(note.category);
                    const isSelected = selectedNote?.id === note.id;
                    
                    return (
                      <List.Item
                        className={`note-item ${isSelected ? 'selected' : ''}`}
                        onClick={() => handleSelectNote(note)}
                      >
                        <Card size="small" className="note-card" hoverable>
                          <div className="note-header">
                            <Space>
                              <span className="category-icon">{categoryInfo.icon}</span>
                              <Text type="secondary" className="category-text">
                                {categoryInfo.label}
                              </Text>
                            </Space>
                            {note.starred && <StarFilled className="star-icon" />}
                          </div>
                          
                          <Title level={5} className="note-title" ellipsis>
                            {note.title}
                          </Title>
                          
                          <Paragraph 
                            className="note-preview" 
                            ellipsis={{ rows: 2 }}
                            type="secondary"
                          >
                            {note.content.replace(/<[^>]*>/g, '')}
                          </Paragraph>
                          
                          <div className="note-tags">
                            {note.tags?.slice(0, 2).map(tag => (
                              <Tag key={tag} size="small">{tag}</Tag>
                            ))}
                            {note.tags?.length > 2 && (
                              <Tag size="small">+{note.tags.length - 2}</Tag>
                            )}
                          </div>
                          
                          <div className="note-meta">
                            <Text type="secondary" className="time-text">
                              <ClockCircleOutlined /> {formatTime(note.updatedAt)}
                            </Text>
                          </div>
                        </Card>
                      </List.Item>
                    );
                  }}
                />
              )}
            </div>
          </div>
        </Sider>

        {/* Âè≥‰æßÁºñËæëÂå∫Âüü */}
        <Content className="editor-content">
          {selectedNote || isEditing ? (
            <div className="editor-container">
              {/* ÁºñËæëÂô®Â§¥ÈÉ® */}
              <div className="editor-header">
                <div className="editor-title">
                  {isEditing ? (
                    <Input
                      value={noteTitle}
                      onChange={(e) => setNoteTitle(e.target.value)}
                      placeholder="ËØ∑ËæìÂÖ•Á¨îËÆ∞Ê†áÈ¢ò"
                      className="title-input"
                      size="large"
                    />
                  ) : (
                    <Title level={3} className="title-display">
                      {selectedNote?.title}
                    </Title>
                  )}
                </div>
                
                <div className="editor-actions">
                  <Space>
                    {isEditing ? (
                      <>
                        <Button 
                          icon={<SaveOutlined />} 
                          type="primary"
                          onClick={handleSaveNote}
                          loading={loading}
                        >
                          ‰øùÂ≠ò
                        </Button>
                        <Button 
                          icon={<CloseOutlined />}
                          onClick={handleCancelEdit}
                        >
                          ÂèñÊ∂à
                        </Button>
                      </>
                    ) : (
                      <Button 
                        icon={<EditOutlined />}
                        type="primary"
                        onClick={handleEditNote}
                      >
                        ÁºñËæë
                      </Button>
                    )}
                  </Space>
                </div>
              </div>

              {/* Ê†áÁ≠æÂå∫Âüü */}
              <div className="tags-section">
                <Space wrap>
                  {selectedTags.map(tag => (
                    <Tag 
                      key={tag} 
                      closable={isEditing}
                      onClose={() => {
                        setSelectedTags(selectedTags.filter(t => t !== tag));
                      }}
                    >
                      {tag}
                    </Tag>
                  ))}
                  {isEditing && (
                    <Select
                      mode="tags"
                      style={{ minWidth: 120 }}
                      placeholder="Ê∑ªÂä†Ê†áÁ≠æ"
                      value={[]}
                      onChange={(newTags) => {
                        const uniqueTags = [...new Set([...selectedTags, ...newTags])];
                        setSelectedTags(uniqueTags);
                      }}
                      options={tags.map(tag => ({ label: tag, value: tag }))}
                    />
                  )}
                </Space>
              </div>

              <Divider style={{ margin: '16px 0' }} />

              {/* ÁºñËæëÂô®ÂÜÖÂÆπ */}
              <div className="editor-body">
                {isEditing ? (
                  <ReactQuill
                    value={editorContent}
                    onChange={setEditorContent}
                    modules={quillModules}
                    formats={quillFormats}
                    placeholder="ÂºÄÂßãÂÜô‰∏ã‰Ω†ÁöÑÊÉ≥Ê≥ï..."
                    className="quill-editor"
                  />
                ) : (
                  <div 
                    className="content-display"
                    dangerouslySetInnerHTML={{ __html: selectedNote?.content || '' }}
                  />
                )}
              </div>
            </div>
          ) : (
            <div className="empty-editor">
              <div className="empty-content">
                <FolderOpenOutlined className="empty-icon" />
                <Title level={4} type="secondary">ÈÄâÊã©‰∏Ä‰∏™Á¨îËÆ∞ÂºÄÂßãÁºñËæë</Title>
                <Text type="secondary">ÊàñËÄÖÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÁ¨îËÆ∞</Text>
                <Button 
                  type="primary" 
                  icon={<PlusOutlined />}
                  onClick={handleCreateNew}
                  style={{ marginTop: 16 }}
                >
                  Êñ∞Âª∫Á¨îËÆ∞
                </Button>
              </div>
            </div>
          )}
        </Content>
      </Layout>
    </Modal>
  );
};

export default NoteCreateModal;